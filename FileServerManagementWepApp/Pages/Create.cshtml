@page
@model FileServerManagementWepApp.Pages.CreateModel

@{
    ViewData["Title"] = "Create";
}

<h1>ایجاد فایل</h1>

<hr />
<div class="row">
    <div class="col-md-4">
        <div id="uploadForm">
            <div class="form-group">
                <label for="file" class="control-label">فایل</label>
                <input type="hidden" name="filename" id="filename" />
                <input class="form-control" type="file" name="file" id="file" />
            </div>
            <div class="form-group">
                <input type="button" onClick="fileUpload1()" value="آپلود" class="btn btn-primary btn-block" />
            </div>
            <div>
                <a asp-page="Index">بازگشت</a>
            </div>
        </div>

        <script>
            var system = "Private";
            var subsystem = "Server";
            var ext = "";
            var size = 0;
            var recId = 0;
            var serverAddress = "";
            var fileId = "";
            var formData = new FormData();

            function fileUpload1() {

                size = ($('#file')[0].files[0].size);
                const lastDot = $('#file')[0].files[0].name.lastIndexOf('.');
                ext = $('#file')[0].files[0].name.substring(lastDot + 1);

                if (size == 0) {
                    toastr.error("zero byte file");
                    return;
                }

                $.ajax({
                    url: 'http://@Request.Headers["host"]/api/server/server',
                    type: 'GET',
                    data: {
                        system: system,
                        subsystem: subsystem,
                        ext: ext,
                        size: size,
                        record: recId
                    },
                    success: function (data) {
                        console.log(data);
                        if (data.data.server == null) {
                            toastr.error(data.data);
                            return;
                        }
                        serverAddress = data.data.server;
                        fileId = data.data.id;
                    },
                    error: function (request, status, error) {
                        toastr.error("Error - Manager server did not response");
                        return;
                    },
                    complete: function () {
                        fileUpload2();
                    }
                });
            }

            function fileUpload2() {

                $('#progressbarModal').modal({ backdrop: 'static', keyboard: false });

                formData.append('file', $('#file')[0].files[0]);
                formData.append('id', fileId);

                $.ajax({
                    xhr: function () {
                        var xhr = new window.XMLHttpRequest();

                        xhr.upload.addEventListener("progress", function (evt) {
                            if (evt.lengthComputable) {
                                var percentComplete = evt.loaded / evt.total;
                                percentComplete = parseInt(percentComplete * 100);
                                $('.progress-bar').width(percentComplete + '%');
                                $('.progress-bar > i').html(percentComplete + '%');
                            }
                        }, false);

                        return xhr;
                    },
                    url: 'http://' + serverAddress + '/api/file/upload',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        $('#btnReleaseAll').toggleClass('d-none');
                    },
                    error: function (request, status, error) {
                        toastr.error("Error - Server did not response");
                        window.setTimeout(function () {
                            window.location.replace('./Index');
                        }, 2000);
                        return;
                    }
                });
            }
        </script>

        <!-- Modal -->
        <div class="modal fade" id="progressbarModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">در حال بارگذاری</h5>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            تا ظاهر شدن دکمه بستن منتظر بمانید، فایل های حجیم پس از آپلود 100% زمانی برای انتقال در سرور نیاز دارند
                        </div>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuemin="0" aria-valuemax="100"><i>0%</i></div>
                        </div>
                    </div>
                    <a onclick="window.location.replace('./Edit?id=' + fileId);" id="btnReleaseAll" class="d-none btn btn-primary btn-default btn-small">بستن &times;</a>
                </div>
            </div>
        </div>
        <!-- Modal -->
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
